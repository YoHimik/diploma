\chapter{РЕАЛИЗАЦИЯ СИСТЕМЫ АВТОМАТИЗАЦИИ УПРАВЛЕНИЯ ЖИЗНЕННЫМ ЦИКЛОМ ВЕБ-СЕРВИСА}
\label{cha:impl}

\section{Подготовка GitLab}

Перед реализацией необходимо произвести базовую настройку окружения.
Для этого был зарегистрирован GitLab аккаунт, установле SSH ключ и создана группа проекта.

Следующим этапом было произведено создание необходимых репозиториев с последующей загрузкой исходного кода предоставленного для работы веб-сервиса:

\begin{itemize}
    \item web-client --- репозиторий для хранения исходного кода веб-клиента проекта,
    \item api --- репозиторий для хранения исходного кода API проекта.
    \item node packages --- репозиторий для хранения исходного кода общих npm зависимостей проекта.
\end{itemize}

Так же в корне каждого репозитория был загружен Dockerfile для развёртки данного сервиса.
Так как в качестве модели ветвления была выбрана модель git flow, то так же были подговлены соответствующие ветки в репозиториях под разные окружения: develop, testing и release.
Установка доступа к данным репозиториям предоставляется только соответсвующим разработчикам данных программных решений в целях безопасности.

На следующем этапе был подготовлен репозиторий deployment для хранения общих скриптов и конфигураций окружения и развёртки.
Установка доступа к этому репозиторию предоставляется только команде обеспечения развёртки в целях безопасности.

Подготвка хранилищ npm пакетов и Docker образов не требуется, так как GitLab берёт на себя данную отвественность и не требует дополнительных действий от пользователя.

\section{Установка кластера Docker Swarm}

Следующим этапом был установлен и настроен Docker Swarm кластер.
Одной и ключевой настройкой является открытие портов на уровне операционной системы сервера:

\begin{itemize}
    \item TCP порт 2377 для коммуникации между менеджерами кластера,
    \item TCP и UDP порты 7946 для взаимодействия между нодами кластера,
    \item UDP порта 4789 для управления сетевым трафиком.
\end{itemize}

Дальше была произведена инициализация кластера на сервера.
В данном этапе нет необходимости при использовании Kubernetes.

\section{Установка и настройка GitLab Runner}

После была произведена установка и настройка GitLab Runner на рабочем сервере.
В качестве дистрибутива на этапе проектирования был выбран Docker, как самый быстрый и удобный.
После установки необходимо зарегистрировать GitLab Runner, для этого на странице настроек CI/CD группы в GitLab был получен регистрационный токен.
Конфигурация runner производится путём редактирования config.toml файла в соответствии с этапом проектирования, основными настройками являются являются:

\begin{itemize}
    \item Установка executor --- docker executor,
    \item Установка volumes --- /var/run/docker.sock,
    \item Установка pull-policy --- if-not-present,
    \item Установка concurrent --- 3.
\end{itemize}

На данном этапе runner полностью готов к работе и ожидает входящих задач.

\section{Описание CI/CD конфигураций}

На следующем этапе необходимо подготовить общие для работы сервисов конфигурации запуска, которые будут храниться в репозитории deployment:

\begin{itemize}
    \item build.yaml --- набор универсальных задач, предназначенный для сборки Docker образа и последующей загрузки в  регистр контейнеров,
    \item publish.yaml --- набор универсальных задач, предназначенный для оповещения кластера о об обонвлении сервиса для загрузки новой версии,
    \item publish-api.yaml --- расширенная версия publish.yaml, содержащая дополнительные задачи для проведения миграция базы данных в случае необходимости,
    \item build-package.yaml --- набор задач для для отслеживания к какому конкретному сервису принадлежит npm пакет путём построения графа зависимостей на основании package.json файлов,
    \item publish-package.yaml --- набор задач для загрузки собранного npm пакета .
\end{itemize}

Далее была произведена конфигурация на уровне сервисов компонентов, в репозитории api и web-client были добавлены конфигурации CI/CD путёт создания .gitlab-ci.yml файла, содержащие основные задачи.

Аналогичные задачи были описаны для репозитория node packages.

\section{Развёртка сервисов внутри кластера}

Завершающим этапом реализации является описание конфигурационных файлов Docker Swarm.
Для этого в настройках CI/CD репозитория deployment были добавлены переменные окружения (секреты) на все рабочие окружния (develop, testing и release),
содержащие аргументы сервисов компонентов системы (доступы к базе данных, секрет ключа авторизации и так далее).
Аналогично были добавлены Docker Swarm конфигурационные файлы под каждый окружения:

\begin{itemize}
    \item develop --- каждый сервис запускается на сервере в одном экзмепляре, ресурсы сервера сильно ограничены во избежание лишней нагрузки,
    \item testing --- аналогичен develop, только используется для целей ручного тестирования веб-сервиса,
    \item release --- web-client запускается в одном экзмепляре, база данных и api запускаются в трёх, большая часть ресурса отведена под эти сервисы.
\end{itemize}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "rpz"
%%% End:
